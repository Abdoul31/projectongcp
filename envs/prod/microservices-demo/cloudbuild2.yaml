
substitutions:
  _REGION: europe-west2
  _REPO: projectongcp
  _PROJECT_ID: manssacloudgcp
######################cloud loging 
serviceAccount: projects/manssacloudgcp/serviceAccounts/github-ci@manssacloudgcp.iam.gserviceaccount.com
#logsBucket: gs://myservices-logs
options:
  logging: CLOUD_LOGGING_ONLY

steps:
#########BUILD iMAGE################
  - name: 'gcr.io/cloud-builders/docker'
    id: 'build-frontend'
    args:
      - build
      - --build-arg
      - BUILDPLATFORM=linux/amd64
      - '-t'
      - '${_REGION}-docker.pkg.dev/${PROJECT_ID}/${_REPO}/frontend:$SHORT_SHA'
      - 'envs/prod/microservices-demo/src/frontend'
      #######SCAN IMAGE################
  - name: 'aquasec/trivy'
    args:
      - image
      - '--severity'
      - 'CRITICAL,HIGH'
      - '--exit-code'
      - '1'
      - '${_REGION}-docker.pkg.dev/${PROJECT_ID}/${_REPO}/frontend:$SHORT_SHA'

##################PUSH D'IMAGE###################
  - name: 'gcr.io/cloud-builders/docker'
    id: 'push-frontend'
    args:
      - push
      - '${_REGION}-docker.pkg.dev/${PROJECT_ID}/${_REPO}/frontend:$SHORT_SHA'
##################BUILD IMAGE########################
  - name: 'gcr.io/cloud-builders/docker'
    id: 'build-adservice'
    args:
      - build
      - --build-arg
      - BUILDPLATFORM=linux/amd64
      - '-t'
      - '${_REGION}-docker.pkg.dev/${PROJECT_ID}/${_REPO}/adservice:$SHORT_SHA'
      - 'envs/prod/microservices-demo/src/adservice'
#################SCAN TRIVY##################""
  - name: 'aquasec/trivy'
    args:
      - image
      - '--severity'
      - 'CRITICAL,HIGH'
      - '--exit-code'
      - '1'
      - '${_REGION}-docker.pkg.dev/${PROJECT_ID}/${_REPO}/adservice:$SHORT_SHA'

  - name: 'gcr.io/cloud-builders/docker'
    id: 'push-adservice'
    args:
      - push
      - '${_REGION}-docker.pkg.dev/${PROJECT_ID}/${_REPO}/adservice:$SHORT_SHA'
################3
  - name: 'gcr.io/cloud-builders/docker'
    id: 'build-cartservice'
    args:
      - build
      - --build-arg
      - BUILDPLATFORM=linux/amd64
      - '-t'
      - '${_REGION}-docker.pkg.dev/${PROJECT_ID}/${_REPO}/cartservice:$SHORT_SHA'
      - 'envs/prod/microservices-demo/src/cartservice'

  - name: 'aquasec/trivy'
    args:
      - image
      - '--severity'
      - 'CRITICAL,HIGH'
      - '--exit-code'
      - '1'
      - '${_REGION}-docker.pkg.dev/${PROJECT_ID}/${_REPO}/cartservice:$SHORT_SHA'

  - name: 'gcr.io/cloud-builders/docker'
    id: 'push-cartservice'
    args:
      - push
      - '${_REGION}-docker.pkg.dev/${PROJECT_ID}/${_REPO}/cartservice:$SHORT_SHA'
      ###############################
  - name: 'gcr.io/cloud-builders/docker'
    id: 'build-checkoutservice'
    args:
      - build
      - --build-arg
      - BUILDPLATFORM=linux/amd64
      - '-t'
      - '${_REGION}-docker.pkg.dev/${PROJECT_ID}/${_REPO}/checkoutservice:$SHORT_SHA'
      - 'envs/prod/microservices-demo/src/checkoutservice'

  - name: 'aquasec/trivy'
    args:
      - image
      - '--severity'
      - 'CRITICAL,HIGH'
      - '--exit-code'
      - '1'
      - '${_REGION}-docker.pkg.dev/${PROJECT_ID}/${_REPO}/checkoutservice:$SHORT_SHA'

  - name: 'gcr.io/cloud-builders/docker'
    id: 'push-checkoutservice'
    args:
      - push
      - '${_REGION}-docker.pkg.dev/${PROJECT_ID}/${_REPO}/checkoutservice:$SHORT_SHA'
      ##################################""
    ###############################
  - name: 'gcr.io/cloud-builders/docker'
    id: 'build-currencyservice'
    args:
      - build
      - --build-arg
      - BUILDPLATFORM=linux/amd64
      - '-t'
      - '${_REGION}-docker.pkg.dev/${PROJECT_ID}/${_REPO}/currencyservice:$SHORT_SHA'
      - 'envs/prod/microservices-demo/src/currencyservice'

  - name: 'aquasec/trivy'
    args:
      - image
      - '--severity'
      - 'CRITICAL,HIGH'
      - '--exit-code'
      - '1'
      - '${_REGION}-docker.pkg.dev/${PROJECT_ID}/${_REPO}/currencyservice:$SHORT_SHA'

  - name: 'gcr.io/cloud-builders/docker'
    id: 'push-currencyservice'
    args:
      - push
      - '${_REGION}-docker.pkg.dev/${PROJECT_ID}/${_REPO}/currencyservice:$SHORT_SHA'
      ##################################""
  - name: 'gcr.io/cloud-builders/docker'
    id: 'build-emailservice'
    args:
      - build
      - --build-arg
      - BUILDPLATFORM=linux/amd64
      - '-t'
      - '${_REGION}-docker.pkg.dev/${PROJECT_ID}/${_REPO}/emailservice:$SHORT_SHA'
      - 'envs/prod/microservices-demo/src/emailservice'

  - name: 'aquasec/trivy'
    args:
      - image
      - '--severity'
      - 'CRITICAL,HIGH'
      - '--exit-code'
      - '1'
      - '${_REGION}-docker.pkg.dev/${PROJECT_ID}/${_REPO}/emailservice:$SHORT_SHA'

  - name: 'gcr.io/cloud-builders/docker'
    id: 'push-emailservice'
    args:
      - push
      - '${_REGION}-docker.pkg.dev/${PROJECT_ID}/${_REPO}/emailservice:$SHORT_SHA'
      ##################################""
  - name: 'gcr.io/cloud-builders/docker'
    id: 'build-loadgenerator'
    args:
      - build
      - --build-arg
      - BUILDPLATFORM=linux/amd64
      - '-t'
      - '${_REGION}-docker.pkg.dev/${PROJECT_ID}/${_REPO}/loadgenerator:$SHORT_SHA'
      - 'envs/prod/microservices-demo/src/loadgenerator'

  - name: 'aquasec/trivy'
    args:
      - image
      - '--severity'
      - 'CRITICAL,HIGH'
      - '--exit-code'
      - '1'
      - '${_REGION}-docker.pkg.dev/${PROJECT_ID}/${_REPO}/loadgenerator:$SHORT_SHA'

  - name: 'gcr.io/cloud-builders/docker'
    id: 'push-loadgenerator'
    args:
      - push
      - '${_REGION}-docker.pkg.dev/${PROJECT_ID}/${_REPO}/loadgenerator:$SHORT_SHA'
         ##################################""
  - name: 'gcr.io/cloud-builders/docker'
    id: 'build-paymentservice'
    args:
      - build
      - --build-arg
      - BUILDPLATFORM=linux/amd64
      - '-t'
      - '${_REGION}-docker.pkg.dev/${PROJECT_ID}/${_REPO}/paymentservice:$SHORT_SHA'
      - 'envs/prod/microservices-demo/src/paymentservice'

  - name: 'aquasec/trivy'
    args:
      - image
      - '--severity'
      - 'CRITICAL,HIGH'
      - '--exit-code'
      - '1'
      - '${_REGION}-docker.pkg.dev/${PROJECT_ID}/${_REPO}/paymentservice:$SHORT_SHA'

  - name: 'gcr.io/cloud-builders/docker'
    id: 'push-paymentservice'
    args:
      - push
      - '${_REGION}-docker.pkg.dev/${PROJECT_ID}/${_REPO}/paymentservice:$SHORT_SHA'
       ##################################""
  - name: 'gcr.io/cloud-builders/docker'
    id: 'build-productcatalogservice'
    args:
      - build
      - --build-arg
      - BUILDPLATFORM=linux/amd64
      - '-t'
      - '${_REGION}-docker.pkg.dev/${PROJECT_ID}/${_REPO}/productcatalogservice:$SHORT_SHA'
      - 'envs/prod/microservices-demo/src/productcatalogservice'

  - name: 'aquasec/trivy'
    args:
      - image
      - '--severity'
      - 'CRITICAL,HIGH'
      - '--exit-code'
      - '1'
      - '${_REGION}-docker.pkg.dev/${PROJECT_ID}/${_REPO}/productcatalogservice:$SHORT_SHA'

  - name: 'gcr.io/cloud-builders/docker'
    id: 'push-productcatalogservice'
    args:
      - push
      - '${_REGION}-docker.pkg.dev/${PROJECT_ID}/${_REPO}/productcatalogservice:$SHORT_SHA'
       ##################################""
  - name: 'gcr.io/cloud-builders/docker'
    id: 'build-recommendationservice'
    args:
      - build
      - --build-arg
      - BUILDPLATFORM=linux/amd64
      - '-t'
      - '${_REGION}-docker.pkg.dev/${PROJECT_ID}/${_REPO}/recommendationservice:$SHORT_SHA'
      - 'envs/prod/microservices-demo/src/recommendationservice'

  - name: 'aquasec/trivy'
    args:
      - image
      - '--severity'
      - 'CRITICAL,HIGH'
      - '--exit-code'
      - '1'
      - '${_REGION}-docker.pkg.dev/${PROJECT_ID}/${_REPO}/recommendationservice:$SHORT_SHA'

  - name: 'gcr.io/cloud-builders/docker'
    id: 'push-recommendationservice'
    args:
      - push
      - '${_REGION}-docker.pkg.dev/${PROJECT_ID}/${_REPO}/recommendationservice:$SHORT_SHA'
         ##################################""
  - name: 'gcr.io/cloud-builders/docker'
    id: 'build-shippingservice'
    args:
      - build
      - --build-arg
      - BUILDPLATFORM=linux/amd64
      - '-t'
      - '${_REGION}-docker.pkg.dev/${PROJECT_ID}/${_REPO}/shippingservice:$SHORT_SHA'
      - 'envs/prod/microservices-demo/src/shippingservice'

  - name: 'aquasec/trivy'
    args:
      - image
      - '--severity'
      - 'CRITICAL,HIGH'
      - '--exit-code'
      - '1'
      - '${_REGION}-docker.pkg.dev/${PROJECT_ID}/${_REPO}/shippingservice:$SHORT_SHA'

  - name: 'gcr.io/cloud-builders/docker'
    id: 'push-shippingservice'
    args:
      - push
      - '${_REGION}-docker.pkg.dev/${PROJECT_ID}/${_REPO}/shippingservice:$SHORT_SHA'
           
  